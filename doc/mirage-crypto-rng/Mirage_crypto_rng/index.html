<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Mirage_crypto_rng (mirage-crypto-rng.Mirage_crypto_rng)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.4"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">mirage-crypto-rng</a> &#x00BB; Mirage_crypto_rng</nav><header class="odoc-preamble"><h1>Module <code><span>Mirage_crypto_rng</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#randomness">Randomness</a></li><li><a href="#usage-notes">Usage notes</a></li><li><a href="#interface">Interface</a></li><li><a href="#rng_examples">Examples</a></li></ul></nav><div class="odoc-content"><h2 id="randomness"><a href="#randomness" class="anchor"></a>Randomness</h2><p>Secure random number generation.</p><p>There are several parts of this module:</p><ul><li>The <a href="module-type-Generator/index.html" title="Generator">signature</a> of generator modules, together with a facility to convert such modules into actual <a href="#type-g" title="g">generators</a>, and functions that operate on this representation.</li><li>A global generator instance, which needs to be initialized by calling <a href="#val-set_default_generator"><code>set_default_generator</code></a>.</li></ul><h2 id="usage-notes"><a href="#usage-notes" class="anchor"></a>Usage notes</h2><p><b>TL;DR</b> Don't forget to seed; don't maintain your own <code>g</code>.</p><p>For common operations on Unix (independent of your asynchronous task library, you can use /dev/urandom or getentropy(3) (actually getrandom(3) on Linux, getentropy() on macOS and BSD systems, BCryptGenRandom on Windows).</p><p>Please ensure to call <code>Mirage_crypto_rng_unix.use_default</code>, or <code>Mirage_crypto_rng_unix.use_dev_urandom</code> (if you only want to use /dev/urandom), or <code>Mirage_crypto_rng_unix.use_getentropy</code> (if you only want to use getrandom/getentropy/BCryptGenRandom).</p><p>For fine-grained control (doing entropy harvesting, etc.), please continue reading the documentation below. <b>Please be aware that the feeding of Fortuna and producing random numbers is not thread-safe</b> (it is on Miou_unix via Pfortuna).</p><p>Suitable entropy feeding of generators are provided by other libraries <span class="xref-unresolved" title="Mirage_crypto_rng_mirage">mirage-crypto-rng-mirage</span> (for MirageOS), and <span class="xref-unresolved" title="Mirage_crypto_rng_miou_unix">mirage-crypto-miou-unix</span> (for Miou_unix).</p><p>The intention is that &quot;initialize&quot; in the respective sub-library is called once, which sets the default generator and registers entropy harvesting asynchronous tasks. The semantics is that the entropy is always fed to the <a href="#val-default_generator" title="default_generator">default generator</a>, which is not necessarily the one set by &quot;initialize&quot;. The reasoning behind this is that the default generator should be used in most setting, and that should be fed a constant stream of entropy.</p><p>The RNGs here are merely the deterministic part of a full random number generation suite. For proper operation, they need to be seeded with a high-quality entropy source.</p><p>Although this module exposes a more fine-grained interface, e.g. allowing manual seeding of generators, this is intended either for implementing entropy-harvesting modules, or very specialized purposes. Users of this library should almost certainly use one of the above entropy libraries, and avoid manually managing the generator seeding.</p><p>Similarly, although it is possible to swap the default generator and gain control over the random stream, this is also intended for specialized applications such as testing or similar scenarios where the RNG needs to be fully deterministic (RFC 6979, deterministic usage of DSA), or as a component of deterministic algorithms which internally rely on pseudorandom streams.</p><p>In the general case, users should not maintain their local instances of <a href="#type-g" title="g">g</a>. All of the generators in a process have to compete for entropy, and it is likely that the overall result will have lower effective unpredictability.</p><p>The recommended way to use these functions is either to accept an optional generator and pass it down, or to ignore the generator altogether, as illustrated in the <a href="#rng_examples" title="rng_examples">examples</a>.</p><h2 id="interface"><a href="#interface" class="anchor"></a>Interface</h2><div class="odoc-spec"><div class="spec type anchored" id="type-g"><a href="#type-g" class="anchor"></a><code><span><span class="keyword">type</span> g</span></code></div><div class="spec-doc"><p>A generator (PRNG) with its state.</p></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Unseeded_generator"><a href="#exception-Unseeded_generator" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Unseeded_generator</span></span></code></div><div class="spec-doc"><p>Thrown when using an uninitialized <a href="#type-g" title="g">generator</a>.</p></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-No_default_generator"><a href="#exception-No_default_generator" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">No_default_generator</span></span></code></div><div class="spec-doc"><p>Thrown when <a href="#val-set_default_generator"><code>set_default_generator</code></a> has not been called.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Entropy"><a href="#module-Entropy" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Entropy/index.html">Entropy</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Entropy sources and collection</p></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-Generator"><a href="#module-type-Generator" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-Generator/index.html">Generator</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>A single PRNG algorithm.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-generator"><a href="#type-generator" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a generator</span></span><span> = <span>(<span class="keyword">module</span> <a href="module-type-Generator/index.html">Generator</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="module-type-Generator/index.html#type-g">g</a> = <span class="type-var">'a</span>)</span></span></code></div></div><p>Ready-to-use RNG algorithms.</p><div class="odoc-spec"><div class="spec module anchored" id="module-Fortuna"><a href="#module-Fortuna" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Fortuna/index.html">Fortuna</a></span><span> : <a href="module-type-Generator/index.html">Generator</a></span></code></div><div class="spec-doc"><p><b>Fortuna</b>, a CSPRNG <a href="https://www.schneier.com/fortuna.html">proposed</a> by Schneier.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Hmac_drbg"><a href="#module-Hmac_drbg" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Hmac_drbg/index.html">Hmac_drbg</a></span><span> (<a href="Hmac_drbg/index.html#argument-1-H">H</a> : <span class="xref-unresolved">Digestif</span>.S) : <a href="module-type-Generator/index.html">Generator</a></span></code></div><div class="spec-doc"><p><b>HMAC_DRBG</b>: A NIST-specified RNG based on HMAC construction over the provided hash.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?g</span>:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?seed</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?strict</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?time</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> int64)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-generator">generator</a></span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-g">g</a></span></code></div><div class="spec-doc"><p><code>create ~g ~seed ~strict ~time module</code> uses a module conforming to the <a href="module-type-Generator/index.html" title="Generator">Generator</a> signature to instantiate the generic generator <a href="#type-g" title="g">g</a>.</p><p><code>g</code> is the state to use, otherwise a fresh one is created.</p><p><code>seed</code> can be provided to immediately reseed the generator with.</p><p><code>strict</code> puts the generator into a more standards-conformant, but slighty slower mode. Useful if the outputs need to match published test-vectors.</p><p><code>time</code> is used to limit the amount of reseedings. Fortuna uses at most once every second.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_generator"><a href="#val-default_generator" class="anchor"></a><code><span><span class="keyword">val</span> default_generator : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-g">g</a></span></code></div><div class="spec-doc"><p><code>default_generator ()</code> is the default generator. Functions in this module use this generator when not explicitly supplied one.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-No_default_generator"><code>No_default_generator</code></a> <p>if <a href="#val-set_default_generator"><code>set_default_generator</code></a> has not been called.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_default_generator"><a href="#val-set_default_generator" class="anchor"></a><code><span><span class="keyword">val</span> set_default_generator : <span><a href="#type-g">g</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_default_generator g</code> sets the default generator to <code>g</code>. This function must be called once.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-generate_into"><a href="#val-generate_into" class="anchor"></a><code><span><span class="keyword">val</span> generate_into : <span><span class="optlabel">?g</span>:<a href="#type-g">g</a> <span class="arrow">&#45;&gt;</span></span> <span>bytes <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?off</span>:int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>generate_into ~g buf ~off len</code> invokes <a href="module-type-Generator/index.html#val-generate_into" title="Generator.generate_into">generate_into</a> on <code>g</code> or <a href="#type-generator" title="generator">default generator</a>. The random data is put into <code>buf</code> starting at <code>off</code> (defaults to 0) with <code>len</code> bytes.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>if buffer is too small (it must be: <code>Bytes.length
      buf - off &gt;= n</code>) or <code>off</code> or <code>n</code> are negative.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-generate"><a href="#val-generate" class="anchor"></a><code><span><span class="keyword">val</span> generate : <span><span class="optlabel">?g</span>:<a href="#type-g">g</a> <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Invoke <a href="#val-generate_into"><code>generate_into</code></a> on <code>g</code> or <a href="#type-generator" title="generator">default generator</a> and a freshly allocated string.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-block"><a href="#val-block" class="anchor"></a><code><span><span class="keyword">val</span> block : <span><span><a href="#type-g">g</a> option</span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><a href="module-type-Generator/index.html#val-block" title="Generator.block">Block</a> size of <code>g</code> or <a href="#type-generator" title="generator">default generator</a>.</p></div></div><h2 id="rng_examples"><a href="#rng_examples" class="anchor"></a>Examples</h2><p>Generating a random 13-byte string:</p><pre class="language-ocaml"><code>let cs = Rng.generate 13</code></pre><p>Generating a list of string, passing down an optional <a href="#type-g" title="g">generator</a>:</p><pre class="language-ocaml"><code>let rec f1 ?g ~n i =
if i &lt; 1 then [] else Rng.generate ?g n :: f1 ?g ~n (i - 1)</code></pre><p>Generating a <code>Z.t</code> smaller than <code>10</code>:</p><pre class="language-ocaml"><code>let f2 ?g () = Mirage_crypto_pk.Z_extra.gen ?g Z.(~$10)</code></pre><p>Creating a local Fortuna instance and using it as a key-derivation function:</p><pre class="language-ocaml"><code>let f3 secret =
let g = Rng.(create ~seed:secret (module Generators.Fortuna)) in
Rng.generate ~g 32</code></pre></div></body></html>
